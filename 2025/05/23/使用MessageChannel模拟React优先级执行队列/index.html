<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用MessageChannel模拟React优先级执行队列"><meta name="keywords" content="JavaScript,ES6,React"><meta name="author" content="Sir_Liu"><meta name="copyright" content="Sir_Liu"><title>使用MessageChannel模拟React优先级执行队列 | Coding Your Life</title><link rel="shortcut icon" href="/vite.svg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Site Name Atom Feed"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4583227810964573" crossorigin="anonymous"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '3.9.0'
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#今天的分享就到这了，如有疑问🤔️评论区见"><span class="toc-number">1.0.1.</span> <span class="toc-text">今天的分享就到这了，如有疑问🤔️评论区见</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/mirror-assets/16d2a30b4d8e2a895e6~tplv-t2oaga2asx-jj-mark:72:72:0:0:q75.avis"></div><div class="author-info__name text-center">Sir_Liu</div><div class="author-info__description text-center">无论从事什么行业，只要做好两件事就够了，一个是你的专业、一个是你的人品，专业决定了你的存在，人品决定了你的人脉，剩下的就是坚持，用善良專業和真诚赢取更多的信任。（No matter what industry you are in, it is enough to do two things well, one is your profession and the other is your character. Your profession determines your existence, and your character determines your network. The rest is persistence, and you should win more trust with kindness, professionalism and sincerity.）</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">18</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">17</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">10</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(chrome-extension://pkfjcehoipcdbiilobhcblbkmelocaka/start/skin/images/bg-51.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coding Your Life</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/atom.xml">rss</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">使用MessageChannel模拟React优先级执行队列</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2025-05-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/前端ES6中API使用/">前端ES6中API使用</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">516</span><span class="post-meta__separator">|</span><span>阅读时长: 2 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>MessageChannel</strong> 是 <strong>HTML5</strong> 中 <strong>window</strong> 对象提供的一个用于跨线程通信的 API，它允许我们在不同的浏览上下文（如主线程与 Worker 线程）之间传递数据。React 利用了 <strong>MessageChannel</strong> 来实现优先级任务调度，模拟异步任务队列。</p>
<blockquote>
<p>以下是关于 <strong>MessageChannel</strong> 的关键点：</p>
</blockquote>
<p><strong>MessageChannel</strong> 创建两个端口 (port1, port2)，它们可以互相发送消息。<br>在 React 的调度器中，使用 <strong>MessageChannel</strong> 将低优先级任务延迟执行，而高优先级任务可以中断低优先级任务。<br>通过 port.postMessage() 将任务加入队列，通过监听 message 事件来触发任务执行。<br>相比 <strong>setTimeout</strong>，<strong>MessageChannel</strong> 提供了更细粒度的控制，并且在浏览器中具有更高的优先级。<br>示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">enum ScheduleType &#123;</span><br><span class="line">  event = <span class="number">1000</span>,</span><br><span class="line">  timeout = <span class="number">2000</span>,</span><br><span class="line">&#125;</span><br><span class="line">type  ScheduleItem = &#123;</span><br><span class="line">  time: number,</span><br><span class="line">  callback: <span class="built_in">Function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSchedule</span> </span>&#123; </span><br><span class="line">    private queue: <span class="built_in">Array</span>&lt;any&gt; = [];</span><br><span class="line">    private port1: MessagePort;</span><br><span class="line">    private port2: MessagePort;</span><br><span class="line">    private isRunning: boolean = <span class="literal">false</span>; </span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel();</span><br><span class="line">     <span class="keyword">this</span>.port1 = channel.port1;</span><br><span class="line">     <span class="keyword">this</span>.port2 = channel.port2;</span><br><span class="line">     <span class="comment">// 这里必须要绑定this</span></span><br><span class="line">     <span class="keyword">this</span>.onSchedule = <span class="keyword">this</span>.onSchedule.bind(<span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">this</span>.port1.onmessage = <span class="keyword">this</span>.onSchedule;</span><br><span class="line">    &#125;</span><br><span class="line">    onSchedule()&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'开始执行了'</span>)</span><br><span class="line">      <span class="keyword">this</span>.queueLoop();</span><br><span class="line">    &#125;</span><br><span class="line">    dispatchMsg()&#123;</span><br><span class="line">       <span class="keyword">this</span>.port2.postMessage(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    schedule(fn: <span class="built_in">Function</span>, <span class="attr">scheduleType</span>: ScheduleType)&#123;</span><br><span class="line">      <span class="keyword">const</span> time = performance.now() + scheduleType;</span><br><span class="line">      <span class="keyword">this</span>.push(&#123;<span class="attr">callback</span>: fn, time &#125;);</span><br><span class="line">      <span class="keyword">if</span>(!<span class="keyword">this</span>.isRunning)&#123;</span><br><span class="line">        <span class="keyword">this</span>.isRunning = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.dispatchMsg();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    push(schedule: ScheduleItem)&#123;</span><br><span class="line">      <span class="keyword">this</span>.queue.push(schedule);</span><br><span class="line">      <span class="keyword">this</span>.queue.sort(<span class="function">(<span class="params">a,b</span>)=&gt;</span>a.time - b.time);</span><br><span class="line">    &#125;</span><br><span class="line">    pop()&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.queue.shift()</span><br><span class="line">    &#125;</span><br><span class="line">   queueLoop()&#123;</span><br><span class="line">     <span class="keyword">let</span> schedule = <span class="keyword">this</span>.pop();</span><br><span class="line">     <span class="keyword">while</span>(schedule)&#123;</span><br><span class="line">         schedule.callback();</span><br><span class="line">         schedule = <span class="keyword">this</span>.pop();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">this</span>.isRunning = <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> simpleSchedule = <span class="keyword">new</span> SimpleSchedule();</span><br><span class="line"></span><br><span class="line">simpleSchedule.schedule(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'schedule 1'</span>);</span><br><span class="line">&#125;,ScheduleType.timeout);</span><br><span class="line"></span><br><span class="line">simpleSchedule.schedule(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'schedule 2'</span>);</span><br><span class="line">&#125;,ScheduleType.event);</span><br><span class="line"><span class="comment">// 打印结果：</span></span><br><span class="line"> 开始执行了</span><br><span class="line"> schedule <span class="number">2</span></span><br><span class="line"> schedule <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>上述代码中，<code>SimpleSchedule</code>类是一个简单的调度器，用于管理多个任务。它使用一个队列来保存任务，并使用一个<code>isRunning</code>属性来指示当前是否正在执行任务。</p>
<p>ts文件可以直接用ts-node运行，如果报错<code>TypeError [ERR_UNKNOWN_FILE_EXTENSION]: Unknown file extension &quot;.ts&quot; for......</code> 请在ts-connfig中添加<code>&quot;ts-node&quot;: { &quot;esm&quot;: true }</code></p>
<h3 id="今天的分享就到这了，如有疑问🤔️评论区见"><a href="#今天的分享就到这了，如有疑问🤔️评论区见" class="headerlink" title="今天的分享就到这了，如有疑问🤔️评论区见"></a>今天的分享就到这了，如有疑问🤔️评论区见</h3></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Sir_Liu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://gofugui.github.io/2025/05/23/使用MessageChannel模拟React优先级执行队列/">https://gofugui.github.io/2025/05/23/使用MessageChannel模拟React优先级执行队列/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gofugui.github.io">Coding Your Life</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JavaScript/">JavaScript</a><a class="post-meta__tags" href="/tags/ES6/">ES6</a><a class="post-meta__tags" href="/tags/React/">React</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2025/05/25/canvas实现代码雨效果/"><i class="fa fa-chevron-left">  </i><span>canvas实现代码雨效果</span></a></div><div class="next-post pull-right"><a href="/2025/05/22/vue3 和 react 虚拟dom/"><span>vue3 和 react 虚拟dom</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'Ov23liqBpY9MxdjqDFTA',
  clientSecret: 'c824e3fe864528851e7734e9f4661a8fd108b390',
  repo: 'gofugui.github.io',
  owner: 'gofugui',
  admin: 'gofugui',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4583227810964573" data-ad-slot="8925032663" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});
</script><footer class="footer-bg" style="background-image: url(chrome-extension://pkfjcehoipcdbiilobhcblbkmelocaka/start/skin/images/bg-51.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2025 By Sir_Liu</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script> <script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>